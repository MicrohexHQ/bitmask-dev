# This script gets executed inside the docker-bundler-apt image.
# (no virtualenv, so all the dependencies must be already installed in the image).

: ${REPO:="https://github.com/leapcode/bitmask-dev"}
: ${BRANCH:="master"}

# build bitmask-systray
# (dependencies should already be in the base image)

export GOPATH=/srv/go
cd /src/leap && git clone --depth 1 --single-branch --branch master https://0xacab.org/leap/bitmask-systray
cd bitmask-systray && go build .

cd /src/leap/bitmask-dev
cd $HOME
echo "[+] CLONING REPO from $REPO [$BRANCH]"
git clone $REPO bitmaskbuild
cd bitmaskbuild
RELEASE=anonvpn-`cat pkg/next-version`
echo "[+] RELEASE: $RELEASE"
git checkout $BRANCH
git fetch --tags
mkdir -p dist/

# nuke mail
rm -rf src/leap/bitmask/mail

# get anonvpn bundle
VIRTUAL_ENV=/usr/local make bundle_anonvpn_linux
# copy systray binary
cp /src/leap/bitmask-systray/bitmask-systray dist/anonvpn-${RELEASE}/lib/
# rename entrypoing
mv dist/anonvpn-${RELEASE}/bitmask dist/anonvpn-${RELEASE}/riseupvpn
cp -r dist/* /dist
